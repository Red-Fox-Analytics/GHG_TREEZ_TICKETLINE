WITH ticketline_cte AS (
   
    SELECT   PRODUCTBRAND, PRODUCTNAME, PRODUCTTYPE ,STOREID , DATECLOSED  
    		, sum (NETSALES) NETSALES 
    FROM {{source('FIVETRAN_DATABASE','ticketline')}}--FIVETRAN_DATABASE.TREEZ_FIVETRAN.TICKETLINE ----
    GROUP BY  PRODUCTBRAND, PRODUCTNAME, PRODUCTTYPE , STOREID , DATECLOSED 
    ORDER BY  PRODUCTBRAND, PRODUCTNAME, PRODUCTTYPE ,STOREID , DATECLOSED   
), inventory_cte AS (    
   
    SELECT   PRODUCTBRAND ,PRODUCTNAME, PRODUCTTYPE, STOREID , CAST(START_DATE AS date) START_DATE ,
    		  sum(DESTROYED_UNITS) DESTROYED_UNITS_RF,sum(RETURNED_UNITS) RETURNED_UNITS_RF
    		, sum(SOLD_UNITS) SOLD_UNITS_RF
    		, sum(AVAILABLE_UNITS) AVAILABLE_UNITS_RF
    		, max(PRICEUNIT) PRICEUNIT_RF
    		, max(COST_PER_UNIT) COST_PER_UNIT_RF
    		, max(EXCISE_TAX_PER_UNIT) EXCISE_TAX_PER_UNIT_RF
    FROM {{source('FIVETRAN_DATABASE','INVENTORY')}}--FIVETRAN_DATABASE.TREEZ_FIVETRAN.INVENTORY  ----
    GROUP BY PRODUCTBRAND ,PRODUCTNAME, PRODUCTTYPE, STOREID , CAST(START_DATE AS date)
    ORDER BY PRODUCTBRAND ,PRODUCTNAME, PRODUCTTYPE, STOREID ,CAST(START_DATE AS date) desc
), tickeline_subtype AS 
(
	 SELECT   PRODUCTBRAND, PRODUCTNAME, PRODUCTTYPE,PRODUCTSUBTYPE ,STOREID , DATECLOSED 
	 FROM FIVETRAN_DATABASE.TREEZ_FIVETRAN.TICKETLINE
	 GROUP BY  PRODUCTBRAND, PRODUCTNAME, PRODUCTTYPE ,PRODUCTSUBTYPE, STOREID , DATECLOSED	 
)
SELECT ic.PRODUCTBRAND PRODUCTBRAND, ic.PRODUCTNAME, ic.PRODUCTTYPE,tsub.PRODUCTSUBTYPE,  ic.STOREID , ic.START_DATE,
		DESTROYED_UNITS_RF, RETURNED_UNITS_RF,SOLD_UNITS_RF, AVAILABLE_UNITS_RF, PRICEUNIT_RF, COST_PER_UNIT_RF, EXCISE_TAX_PER_UNIT_RF
		, tc.NETSALES NETSALES_RF
FROM inventory_cte ic
left JOIN ticketline_cte tc
	ON ic.PRODUCTBRAND= tc.PRODUCTBRAND AND ic.PRODUCTNAME=tc.PRODUCTNAME AND  ic.PRODUCTTYPE=tc.PRODUCTTYPE
 	AND ic.STOREID=tc.STOREID AND ic.START_DATE=tc.DATECLOSED 
LEFT JOIN tickeline_subtype tsub 
    ON ic.PRODUCTBRAND= tsub.PRODUCTBRAND AND ic.PRODUCTNAME=tsub.PRODUCTNAME AND  ic.PRODUCTTYPE=tsub.PRODUCTTYPE
 	AND ic.STOREID=tsub.STOREID AND ic.START_DATE=tsub.DATECLOSED 
 